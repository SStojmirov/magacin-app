<!DOCTYPE html>
<html lang="mk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Магацин Апликација</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    body { background-color: #1f2937; color: #f3f4f6; font-family: Arial, sans-serif; margin:0; padding:0; }
    .container { max-width: 800px; margin: 20px auto; padding: 20px; }
    .hidden { display: none; }
    button { background-color: #374151; color: #f3f4f6; border: none; padding: 10px 15px; margin: 5px; border-radius:5px; cursor: pointer; }
    button:hover { background-color: #4b5563; }
    select, input { padding: 5px; border-radius: 5px; border: none; background-color: #374151; color: #f3f4f6; }
    #izvestajContainer {
  margin-top: 20px;
}

.card {
  padding: 8px;
  margin: 4px 0;
  border-radius: 4px;
  font-weight: bold;
}

.card.green { background-color: #c8e6c9; }  /* над минимум */
.card.red { background-color: #ffcdd2; }    /* под минимум */
  </style>
</head>
<body>
<div class="container">
  <h1>Магацин Апликација</h1>

  <div id="loginDiv">
    <h2>Лозинка за пристап</h2>
    <input type="password" id="passInput" placeholder="Лозинка">
    <button onclick="login()">Влези</button>
  </div>

  <div id="appDiv" class="hidden">
    <div id="menuDiv">
      <button onclick="showTab('vnes')">Внес</button>
      <button onclick="showTab('izlez')">Излез</button>
      <button onclick="showTab('izvestaj')">Извештај</button>
      <button onclick="showTab('ocekivano')">Очекувано</button>
      <button onclick="logout()">ЛогАут</button>
    </div>

    <div id="vnesDiv" class="hidden card">
      <h3>Внес на артикл</h3>
      <label>Категорија:</label>
      <select id="catSelect"></select><br>
      <label>Артикл:</label>
      <select id="artiklSelect"></select><br>
      <label>Количина:</label>
      <input type="number" id="vnesKolicina"><br>
      <button onclick="dodadiVnes()">Додади</button>
      <div id="lastVnes"></div>
    </div>

    <div id="izlezDiv" class="hidden card">
      <label>Категорија:</label>
<select id="izlezCatSelect"></select><br>
<label>Артикл:</label>
<select id="izlezSelect"></select><br>
<label>Количина:</label>
<input type="number" id="izlezKolicina"><br>
<button onclick="dodadiIzlez()">Додади Излез</button>

    </div>

    <div id="izvestajDiv" class="hidden card">
      <h3>Моментална состојба</h3>
      <div id="izvestajContainer">
  <label>Филтер по категорија:</label>
  <select id="izvestajCatSelect"></select>
  <div id="izvestajList"></div>
</div>



    </div>

    <div id="ocekivanoDiv" class="hidden card">
  <h3>Очекувано (нарачано)</h3>
  <label>Артикл:</label>
  <select id="ocekSelect"></select><br>
  <label>Количина:</label>
  <input type="number" id="ocekKolicina"><br>
  <button onclick="dodadiOcek()">Додади Очекувано</button>
  <div id="ocekList"></div>
</div>
</div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAbCqqSwKQ62Q38K-DM15jsZQePloDD8XM",
  authDomain: "magacinapp-6a8f5.firebaseapp.com",
  projectId: "magacinapp-6a8f5",
  storageBucket: "magacinapp-6a8f5.firebasestorage.app",
  messagingSenderId: "160054879907",
  appId: "1:160054879907:web:ded639dcd0a9e0a64e4116"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const PASSWORD = "1234";

function login(){
  const p = document.getElementById('passInput').value;
  if(p===PASSWORD){
    document.getElementById('loginDiv').classList.add('hidden');
    document.getElementById('appDiv').classList.remove('hidden');
    loadArtikli();
    loadIzlez();
    loadOcek();
    loadIzvestaj();
  } else { alert('Неточна лозинка'); }
}
function logout(){ location.reload(); }

function showTab(tab){
  ['vnesDiv','izlezDiv','izvestajDiv','ocekivanoDiv'].forEach(d=>{
    document.getElementById(d).classList.add('hidden');
  });
  document.getElementById(tab+'Div').classList.remove('hidden');
}

let artikliData = [];

async function loadArtikli(){
  const snap = await db.collection('artikli').get();
  artikliData = snap.docs.map(d=>({id:d.id, ...d.data()}));
  const catSelect = document.getElementById('catSelect');
  const artiklSelect = document.getElementById('artiklSelect');
  catSelect.innerHTML='<option value="">Сите категории</option>';
  artiklSelect.innerHTML='';
  const cats = [...new Set(artikliData.map(a=>a.kategorija))];
  cats.forEach(c=>{ catSelect.innerHTML+=`<option value='${c}'>${c}</option>`; });
  artikliData.forEach(a=>{ artiklSelect.innerHTML+=`<option value='${a.id}'>${a.ime} (${a.merka})</option>` });
}

function filterArtikli(){
  const cat = document.getElementById('catSelect').value;
  const sel = document.getElementById('artiklSelect');
  sel.innerHTML='';
  artikliData.filter(a=>!cat||a.kategorija===cat).forEach(a=>{ sel.innerHTML+=`<option value='${a.id}'>${a.ime} (${a.merka})</option>`; });
}
document.getElementById('catSelect').addEventListener('change', filterArtikli);

async function dodadiVnes(){
  const aId = document.getElementById('artiklSelect').value;
  const k = Number(document.getElementById('vnesKolicina').value);
  if(!aId||!k){ alert('Пополни полиња'); return; }
  const a = artikliData.find(x=>x.id===aId);
  await db.collection('promet').add({
    artiklId:a.id, ime:a.ime, merka:a.merka, kategorija:a.kategorija, kolicina:k, tip:'vnes', datum:new Date()
  });
  document.getElementById('vnesKolicina').value='';
  document.getElementById('lastVnes').innerText=`Последен внес: ${a.ime} - ${k} ${a.merka}`;
  loadIzvestaj();
}

// Вчитување на артикли во табот „Излез“
async function loadIzlez(){
  const catSelect = document.getElementById('izlezCatSelect');
  const sel = document.getElementById('izlezSelect');
  sel.innerHTML='';
  catSelect.innerHTML='<option value="">Сите категории</option>';

  // Пресметка на моментална количина
  const snap = await db.collection('promet').get();
  const records = snap.docs.map(d=>d.data());
  const map = new Map();
  records.forEach(r=>{
    const key = r.artiklId;
    const cur = map.get(key) || { kolicina:0 };
    cur.kolicina += (r.tip==='vnes' ? r.kolicina : -r.kolicina);
    map.set(key, cur);
  });

  // Додавање на категории
  const cats = [...new Set(artikliData.map(a=>a.kategorija))];
  cats.forEach(c => { catSelect.innerHTML += `<option value="${c}">${c}</option>`; });

  // Додавање на артикли со количина > 0
  artikliData.forEach(a=>{
    const kolicina = map.get(a.id)?.kolicina || 0;
    if(kolicina > 0){
      sel.innerHTML += `<option value="${a.id}">${a.ime} (${kolicina} ${a.merka})</option>`;
    }
  });
}

// Филтрирање по категорија
document.getElementById('izlezCatSelect').addEventListener('change', async ()=>{
  const cat = document.getElementById('izlezCatSelect').value;
  const sel = document.getElementById('izlezSelect');
  sel.innerHTML='';

  // Пресметка на количина
  const snap = await db.collection('promet').get();
  const records = snap.docs.map(d=>d.data());
  const map = new Map();
  records.forEach(r=>{
    const key = r.artiklId;
    const cur = map.get(key) || { kolicina:0 };
    cur.kolicina += (r.tip==='vnes' ? r.kolicina : -r.kolicina);
    map.set(key, cur);
  });

  artikliData.forEach(a=>{
    const kolicina = map.get(a.id)?.kolicina || 0;
    if(kolicina > 0 && (!cat || a.kategorija===cat)){
      sel.innerHTML += `<option value="${a.id}">${a.ime} (${kolicina} ${a.merka})</option>`;
    }
  });
});

// Внес на излез со проверка за достапна количина
async function dodadiIzlez(){
  const aId = document.getElementById('izlezSelect').value;
  const k = Number(document.getElementById('izlezKolicina').value);
  if(!aId||!k){ alert('Пополни полиња'); return; }

  // Пресметка на моментална количина
  const snap = await db.collection('promet').get();
  const records = snap.docs.map(d=>d.data());
  const map = new Map();
  records.forEach(r=>{
    const key = r.artiklId;
    const cur = map.get(key) || { kolicina:0 };
    cur.kolicina += (r.tip==='vnes' ? r.kolicina : -r.kolicina);
    map.set(key, cur);
  });

  const dostupno = map.get(aId)?.kolicina || 0;
  if(k > dostupno){
    alert(`Немаш доволно количина! Достапно: ${dostupno}`);
    return;
  }

  const a = artikliData.find(x=>x.id===aId);
  await db.collection('promet').add({
    artiklId:a.id, ime:a.ime, merka:a.merka, kategorija:a.kategorija, kolicina:k, tip:'izlez', datum:new Date()
  });

  document.getElementById('izlezKolicina').value='';
  loadIzvestaj();
  loadIzlez(); // обнови dropdown
}


// Пополнување dropdown со категории
function loadIzvestajCategories(){
  const catSelect = document.getElementById('izvestajCatSelect');
  catSelect.innerHTML = '<option value="">Сите категории</option>'; // најгоре

  const cats = [...new Set(artikliData.map(a=>a.kategorija))];
  cats.forEach(c => { 
    catSelect.innerHTML += `<option value="${c}">${c}</option>`; 
  });
}

// Вчитување на извештај со боја и филтер по категорија
async function loadIzvestaj(){
  const selectedCat = document.getElementById('izvestajCatSelect').value;

  const snap = await db.collection('promet').get();
  const records = snap.docs.map(d=>d.data());

  const map = new Map();
  records.forEach(r=>{
    const key = r.artiklId;
    const cur = map.get(key) || { 
      ime: r.ime, 
      merka: r.merka, 
      kategorija: r.kategorija, 
      kolicina: 0, 
      minKolicina: (artikliData.find(a=>a.id===key)||{}).minKolicina || 0 
    };
    cur.kolicina += (r.tip==='vnes' ? r.kolicina : -r.kolicina);
    map.set(key, cur);
  });

  let list = Array.from(map.values());
  if(selectedCat) list = list.filter(a => a.kategorija === selectedCat);

  // Артикли под минимум на почеток
  list.sort((a,b)=>{
    const aLow = a.kolicina <= a.minKolicina ? 0 : 1;
    const bLow = b.kolicina <= b.minKolicina ? 0 : 1;
    return aLow - bLow;
  });

  const div = document.getElementById('izvestajList');
  div.innerHTML='';
  list.forEach(a=>{
    const cls = a.kolicina <= a.minKolicina ? 'red' : 'green';
    div.innerHTML += `<div class='card ${cls}'>${a.ime} (${a.merka}) - ${a.kolicina}</div>`;
  });
}

// Event listener за категорија
document.getElementById('izvestajCatSelect').addEventListener('change', ()=>{
  loadIzvestaj();
});

// Повик при стартување на страната
loadIzvestajCategories();
loadIzvestaj();


async function loadOcek(){
  const sel = document.getElementById('ocekSelect');
  sel.innerHTML='';
  artikliData.forEach(a=>{ sel.innerHTML+=`<option value='${a.id}'>${a.ime} (${a.merka})</option>` });
  const snap = await db.collection('ocekivano').get();
  const div = document.getElementById('ocekList');
  div.innerHTML='';
  snap.docs.forEach(d=>{
    const r = d.data();
    div.innerHTML+=`<div class='card'>${r.ime} (${r.merka}) - ${r.kolicina}</div>`;
  });
}

async function dodadiOcek(){
  const aId = document.getElementById('ocekSelect').value;
  const k = Number(document.getElementById('ocekKolicina').value);
  if(!aId||!k){ alert('Пополни полиња'); return; }
  const a = artikliData.find(x=>x.id===aId);
  await db.collection('ocekivano').add({artiklId:a.id, ime:a.ime, merka:a.merka, kategorija:a.kategorija, kolicina:k, datum:new Date()});
  document.getElementById('ocekKolicina').value='';
  loadOcek();
}
</script>
</body>
