<!DOCTYPE html>
<html lang="mk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Магацин Апликација</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
  body { background-color: #1f2937; color: #f3f4f6; font-family: Arial, sans-serif; margin:0; padding:0; }
    .container { max-width: 800px; margin: 20px auto; padding: 20px; }
    .hidden { display: none; }
    button { background-color: #374151; color: #f3f4f6; border: none; padding: 10px 15px; margin: 5px; border-radius:5px; cursor: pointer; }
    button:hover { background-color: #4b5563; }
    select, input { padding: 5px; border-radius: 5px; border: none; background-color: #374151; color: #f3f4f6; }
   #izvestajContainer {
  margin-top: 20px;
}

.card {
  padding: 8px;
  margin: 4px 0;
  border-radius: 4px;
  font-weight: bold;
}

.card.green { background-color: #2cb130; }  /* над минимум */
.card.red { background-color: #d53e4e; }    /* под минимум */

/* ===== Мобилен респонзив ===== */
@media (max-width: 600px) {
  /* Контейнер и padding */
  .container {
    padding: 10px;
    margin: 10px;
  }

  #loginDiv {
    idth: 100%;
    margin: 5px 0;
    padding: 12px;
    font-size: 1rem;
  }
  
  /* Таб копчиња full-width */
  #menuDiv button {
    width: 100%;
    margin: 5px 0;
    padding: 12px;
    font-size: 1rem;
  }

  /* Input и select full-width */
  select, input {
    width: 100%;
    padding: 10px;
    font-size: 1rem;
    margin-bottom: 10px;
  }

  /* Cards вертикални, полесни за читање */
  .card {
    flex-direction: column;
    align-items: flex-start;
    padding: 10px 12px;
    font-size: 0.95rem;
  }

  /* Извештај scrollable */
  #izvestajList {
    max-height: 60vh;
    overflow-y: auto;
    padding-right: 4px;
  }
}

  </style>
</head>
<body>
<div class="container">
  <h1>Магацин Апликација</h1>

  <div id="loginDiv">
    <h2>Лозинка за пристап</h2>
    <input type="password" id="passInput" placeholder="Лозинка">
    <button onclick="login()">Влези</button>
  </div>

  <div id="appDiv" class="hidden">
    <div id="menuDiv">
      <button onclick="showTab('vnes')">Внес</button>
      <button onclick="showTab('izlez')">Излез</button>
      <button onclick="showTab('izvestaj')">Извештај</button>
      <button onclick="showTab('pregledPromet')">Преглед промет</button>
      <button onclick="showTab('ocekivano')">Очекувано</button>
      <button onclick="logout()">ЛогАут</button>
    </div>

    <div id="vnesDiv" class="hidden card">
      <h3>Внес на артикл</h3>
      <label>Категорија:</label>
      <select id="catSelect"></select><br><br>
      <label>Артикл:</label>
      <select id="artiklSelect"></select><br><br>
      <label>Количина:</label>
      <input type="number" inputmode="numeric" id="vnesKolicina"><br><br>
      <button onclick="dodadiVnes()">Додади</button>
      <div id="lastVnes"></div>
    </div>

    <div id="izlezDiv" class="hidden card">
      <label>Категорија:</label>
<select id="izlezCatSelect"></select><br><br>
<label>Артикл:</label>
<select id="izlezSelect"></select><br><br>
<label>Количина:</label>
<input type="number" inputmode="numeric" id="izlezKolicina"><br><br>
<button onclick="dodadiIzlez()">Додади Излез</button>

    </div>

    <div id="izvestajDiv" class="hidden card">
      <h3>Моментална состојба</h3>
      <div id="izvestajContainer">
  <label>Филтер по категорија:</label>
  <select id="izvestajCatSelect">
    <option value="">Сите категории</option>
  </select>
  <div id="izvestajList"></div>
</div>


    </div>
<div id="pregledPrometDiv" class="hidden card">
  <h3>Преглед на промет</h3>
  <label>Од датум:</label>
  <input type="date" id="prometOd"><br><br>
  <label>До датум:</label>
  <input type="date" id="prometDo"><br><br>
  <button onclick="loadPregledPromet()">Прикажи</button>
  <div id="pregledPrometList" style="margin-top:10px;"></div>
</div>
    <div id="ocekivanoDiv" class="hidden card">
  <h3>Очекувано (нарачано)</h3>

  <label>Категорија:</label>
  <select id="ocekCatSelect" onchange="loadOcekArtikli()">
    <option value="">Избери категорија</option>
  </select><br><br>

  <label>Артикл:</label>
  <select id="ocekSelect"></select><br><br>

  <label>Количина:</label>
  <input type="number" id="ocekKolicina" min="1" placeholder="Внеси количина"><br><br>

  <label>Очекуван датум:</label>
  <input type="date" id="ocekDatum"><br><br>

  <button onclick="dodadiOcek()">Додади Очекувано</button>

  <div id="ocekList" style="margin-top:10px;"></div>
</div>
  

</div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAbCqqSwKQ62Q38K-DM15jsZQePloDD8XM",
  authDomain: "magacinapp-6a8f5.firebaseapp.com",
  projectId: "magacinapp-6a8f5",
  storageBucket: "magacinapp-6a8f5.firebasestorage.app",
  messagingSenderId: "160054879907",
  appId: "1:160054879907:web:ded639dcd0a9e0a64e4116"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const PASSWORD = "1234";

async function login() {
  const p = document.getElementById('passInput').value;
  if(p === PASSWORD){
    document.getElementById('loginDiv').classList.add('hidden');
    document.getElementById('appDiv').classList.remove('hidden');
    await loadArtikli();
    loadIzlez();
    initIzvestaj();
    initOcek(); // иницијализирај очекувано
  } else { alert('Неточна лозинка'); }
}

function logout(){ location.reload(); }

function showTab(tab){
  // Листа на сите табови
  const allTabs = ['vnesDiv','izlezDiv','izvestajDiv','pregledPrometDiv','ocekivanoDiv'];
  
  // Скриј ги сите табови
  allTabs.forEach(t => {
    document.getElementById(t).classList.add('hidden');
  });

  // Прикажи само избраниот
  document.getElementById(tab+'Div').classList.remove('hidden');

  // Ако не е извештај, исчисти го изvestajList
  if(tab !== 'izvestaj') {
    document.getElementById('izvestajList').innerHTML = '';
  }

  // Ако не е Преглед на промет, исчисти го списокот
  if(tab !== 'pregledPromet') {
    document.getElementById('pregledPrometList').innerHTML = '';
  }
}


let artikliData = [];

async function loadArtikli(){
  const snap = await db.collection('artikli').get();
  artikliData = snap.docs.map(d=>({id:d.id, ...d.data()}));
  
  const catSelect = document.getElementById('catSelect');
  const artiklSelect = document.getElementById('artiklSelect');
  catSelect.innerHTML='<option value="">Сите категории</option>';
  artiklSelect.innerHTML='';

  const cats = [...new Set(artikliData.map(a=>a.kategorija))];
  cats.forEach(c=>{ catSelect.innerHTML+=`<option value='${c}'>${c}</option>`; });
  artikliData.forEach(a=>{ artiklSelect.innerHTML+=`<option value='${a.id}'>${a.ime} (${a.merka})</option>` });
}

function filterArtikli(){
  const cat = document.getElementById('catSelect').value;
  const sel = document.getElementById('artiklSelect');
  sel.innerHTML='';
  artikliData.filter(a=>!cat||a.kategorija===cat).forEach(a=>{ sel.innerHTML+=`<option value='${a.id}'>${a.ime} (${a.merka})</option>`; });
}
document.getElementById('catSelect').addEventListener('change', filterArtikli);

async function dodadiVnes(){
  const aId = document.getElementById('artiklSelect').value;
  const k = Number(document.getElementById('vnesKolicina').value);
  if(!aId||!k){ alert('Пополни полиња'); return; }
  const a = artikliData.find(x=>x.id===aId);
  await db.collection('promet').add({
    artiklId:a.id, ime:a.ime, merka:a.merka, kategorija:a.kategorija, kolicina:k, tip:'vnes', datum:new Date()
  });
  document.getElementById('vnesKolicina').value='';
  document.getElementById('lastVnes').innerText=`Последен внес: ${a.ime} - ${k} ${a.merka}`;
  loadIzvestaj();
}

// Излез
async function loadIzlez(){
  const catSelect = document.getElementById('izlezCatSelect');
  const sel = document.getElementById('izlezSelect');
  sel.innerHTML='';
  catSelect.innerHTML='<option value="">Сите категории</option>';

  const snap = await db.collection('promet').get();
  const records = snap.docs.map(d=>d.data());
  const map = new Map();
  records.forEach(r=>{
    const key = r.artiklId;
    const cur = map.get(key) || { kolicina:0 };
    cur.kolicina += (r.tip==='vnes' ? r.kolicina : -r.kolicina);
    map.set(key, cur);
  });

  const cats = [...new Set(artikliData.map(a=>a.kategorija))];
  cats.forEach(c => { catSelect.innerHTML += `<option value="${c}">${c}</option>`; });

  artikliData.forEach(a=>{
    const kolicina = map.get(a.id)?.kolicina || 0;
    if(kolicina > 0){
      sel.innerHTML += `<option value="${a.id}">${a.ime} (${kolicina} ${a.merka})</option>`;
    }
  });
}

document.getElementById('izlezCatSelect').addEventListener('change', loadIzlez);

async function dodadiIzlez(){
  const aId = document.getElementById('izlezSelect').value;
  const k = Number(document.getElementById('izlezKolicina').value);
  if(!aId||!k){ alert('Пополни полиња'); return; }

  const snap = await db.collection('promet').get();
  const records = snap.docs.map(d=>d.data());
  const map = new Map();
  records.forEach(r=>{
    const key = r.artiklId;
    const cur = map.get(key) || { kolicina:0 };
    cur.kolicina += (r.tip==='vnes' ? r.kolicina : -r.kolicina);
    map.set(key, cur);
  });

  const dostupno = map.get(aId)?.kolicina || 0;
  if(k > dostupno){
    alert(`Немаш доволно количина! Достапно: ${dostupno}`);
    return;
  }

  const a = artikliData.find(x=>x.id===aId);
  await db.collection('promet').add({
    artiklId:a.id, ime:a.ime, merka:a.merka, kategorija:a.kategorija, kolicina:k, tip:'izlez', datum:new Date()
  });

  document.getElementById('izlezKolicina').value='';
  loadIzvestaj();
  loadIzlez();
}

// Извештај
function initIzvestaj(){
  const catSelect = document.getElementById('izvestajCatSelect');
  catSelect.innerHTML = '<option value="">Сите категории</option>';
  const cats = [...new Set(artikliData.map(a=>a.kategorija))];
  cats.forEach(c => { catSelect.innerHTML += `<option value="${c}">${c}</option>`; });

  loadIzvestaj();
}
async function loadIzvestaj(){
  const selectedCat = document.getElementById('izvestajCatSelect').value;
  const snap = await db.collection('promet').get();
  const records = snap.docs.map(d=>d.data());
  const map = new Map();
  records.forEach(r=>{
    const key = r.artiklId;
    const cur = map.get(key) || { 
      ime: r.ime, merka: r.merka, kategorija: r.kategorija, kolicina:0,
      minKolicina: (artikliData.find(a=>a.id===key)||{}).minKolicina||0
    };
    cur.kolicina += (r.tip==='vnes'?r.kolicina:-r.kolicina);
    map.set(key, cur);
  });
  let list = Array.from(map.values());
  if(selectedCat) list = list.filter(a=>a.kategorija===selectedCat);

  list.sort((a,b)=>{
    const aLow = a.kolicina <= a.minKolicina ? 0:1;
    const bLow = b.kolicina <= b.minKolicina ? 0:1;
    return aLow-bLow;
  });

  const div = document.getElementById('izvestajList');
  div.innerHTML='';
  list.forEach(a=>{
    const cls = a.kolicina <= a.minKolicina ? 'red':'green';
    div.innerHTML += `<div class='card ${cls}'>${a.ime} (${a.merka}) - ${a.kolicina}</div>`;
  });
}
document.getElementById('izvestajCatSelect').addEventListener('change', loadIzvestaj);

// Очекувано
function initOcek(){
  loadOcekCategories();
  loadOcekArtikli();
  loadOcekList();
}

function loadOcekCategories() {
  const ocekCatSelect = document.getElementById('ocekCatSelect');
  ocekCatSelect.innerHTML = '<option value="">Избери категорија</option>';
  const categories = [...new Set(artikliData.map(a=>a.kategorija))];
  categories.forEach(cat => {
    const option = document.createElement('option');
    option.value = cat;
    option.textContent = cat;
    ocekCatSelect.appendChild(option);
  });
}

function loadOcekArtikli() {
  const ocekSelect = document.getElementById('ocekSelect');
  const selectedCat = document.getElementById('ocekCatSelect').value;
  ocekSelect.innerHTML = '';
  if(!selectedCat) return;
  const filtered = artikliData.filter(a=>a.kategorija===selectedCat);
  filtered.forEach(a=>{
    const option = document.createElement('option');
    option.value = a.id;
    option.textContent = a.ime;
    ocekSelect.appendChild(option);
  });
}

function dodadiOcek(){
  const artiklId = document.getElementById('ocekSelect').value;
  const kolicina = Number(document.getElementById('ocekKolicina').value);
  const datum = document.getElementById('ocekDatum').value;
  if(!artiklId||!kolicina||!datum){ alert('Внеси артикл, количина и датум!'); return; }
  const artiklObj = artikliData.find(a=>a.id===artiklId);
  db.collection('ocekuvano').add({
    artiklId:artiklObj.id,
    artikl:artiklObj.ime,
    kolicina:kolicina,
    datum:datum,
    kategorija:artiklObj.kategorija,
    merka:artiklObj.merka,
    timestamp:firebase.firestore.FieldValue.serverTimestamp()
  }).then(()=>{
    document.getElementById('ocekKolicina').value='';
    document.getElementById('ocekDatum').value='';
    loadOcekList();
  });
}

function loadOcekList(){
  const ocekList = document.getElementById('ocekList');
  ocekList.innerHTML='';
  db.collection('ocekuvano').orderBy('timestamp','desc').get().then(snapshot=>{
    snapshot.forEach(doc=>{
      const data = doc.data();
      const div = document.createElement('div');
      div.classList.add('card');
      div.style.display='flex';
      div.style.justifyContent='space-between';
      div.style.alignItems='center';
      div.style.marginBottom='4px';

      const text = document.createElement('span');
      text.textContent = `${data.artikl} (${data.kolicina} ${data.merka}) | Очекуван датум: ${data.datum}`;

      const delBtn = document.createElement('button');
      delBtn.textContent='Избриши';
      delBtn.onclick = ()=>{ if(confirm('Дали си сигурен?')) db.collection('ocekuvano').doc(doc.id).delete().then(loadOcekList); }

      div.appendChild(text);
      div.appendChild(delBtn);
      ocekList.appendChild(div);
    });
  });
}

// Event listener за таб „Очекувано“
document.getElementById('ocekCatSelect').addEventListener('change', loadOcekArtikli);

async function loadPregledPromet() {
  const od = document.getElementById('prometOd').value;
  const doD = document.getElementById('prometDo').value;
  const listDiv = document.getElementById('pregledPrometList');
  listDiv.innerHTML = '';

  if(!od || !doD){
    alert('Избери и од и до датум!');
    return;
  }

  const odDate = new Date(od);
  const doDate = new Date(doD);
  // да вклучи целиот ден
  doDate.setHours(23,59,59,999);

  const snap = await db.collection('promet').orderBy('datum','asc').get();
  const records = snap.docs.map(d=>({id:d.id, ...d.data()}))
                          .filter(r=>{
                            const d = r.datum.toDate ? r.datum.toDate() : new Date(r.datum);
                            return d >= odDate && d <= doDate;
                          });

  records.forEach(r=>{
    const cls = r.tip==='vnes' ? 'green' : 'red';
    const d = r.datum.toDate ? r.datum.toDate() : new Date(r.datum);
    const div = document.createElement('div');
    div.classList.add('card', cls);
    div.textContent = `${r.ime} (${r.kolicina} ${r.merka}) | ${r.tip.toUpperCase()} | ${d.toLocaleDateString()}`;
    listDiv.appendChild(div);
  });
}

  
// На мобилен при стартување покажи првиот таб (Внес)
if(window.innerWidth <= 600){
  showTab('vnes');
}


</script>
</body>
