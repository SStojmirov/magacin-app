<!DOCTYPE html>
<html lang="mk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ú–∞–≥–∞—Ü–∏–Ω</title>
<style>
body { margin:0; font-family: Arial, sans-serif; background: linear-gradient(135deg,#1f1f1f,#333); display:flex; justify-content:center; align-items:center; min-height:100vh; }
#login-card, #dashboard, .tab { display:none; background:#fff; border-radius:12px; padding:30px; box-shadow:0 8px 20px rgba(0,0,0,0.3); width:360px; text-align:center; max-height:90vh; overflow:auto; }
input, button, select { width:100%; padding:10px; margin:5px 0; border-radius:6px; font-size:16px; }
button { border:none; background:#007BFF; color:#fff; cursor:pointer; }
button:hover { background:#0056b3; }
h2{text-align:center;}
.menu button { width:90%; margin:8px 0; }
.back-btn { background:#555; }
#vnesLista, #izlezLista, #lista, #oczekDiv, #kontrolaLista { margin-top:10px; }
#vnesLista div, #izlezLista div, #lista div, #oczekDiv div, #kontrolaLista div { padding:5px; border:1px solid #ddd; margin:3px 0; border-radius:5px; text-align:left; }
.red { color:red; font-weight:bold; }
</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, Timestamp } 
from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// üîπ Firebase –∫–æ–Ω—Ñ–∏–≥
const firebaseConfig = {
  apiKey: "AIzaSyAbCqqSwKQ62Q38K-DM15jsZQePloDD8XM",
  authDomain: "magacinapp-6a8f5.firebaseapp.com",
  projectId: "magacinapp-6a8f5",
  storageBucket: "magacinapp-6a8f5.firebasestorage.app",
  messagingSenderId: "160054879907",
  appId: "1:160054879907:web:ded639dcd0a9e0a64e4116"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// üîπ –õ–æ–∑–∏–Ω–∫–∞
const password = "1234";
window.addEventListener("load", ()=>{
  if(localStorage.getItem("magacin_pass")===password){ showDashboard(); } 
  else { document.getElementById("login-card").style.display="block"; }
});

function checkLogin(){
  const input = document.getElementById("pass").value;
  if(input===password){ localStorage.setItem("magacin_pass",password); showDashboard(); } 
  else { alert("–ù–µ—Ç–æ—á–Ω–∞ –ª–æ–∑–∏–Ω–∫–∞!"); }
}
window.checkLogin=checkLogin;

function showDashboard(){ 
  document.getElementById("login-card").style.display="none"; 
  document.getElementById("dashboard").style.display="block"; 
  hideTabs(); 
}
function hideTabs(){ document.querySelectorAll(".tab").forEach(t=>t.style.display="none"); }

function showTab(id){
  hideTabs();
  const tab = document.getElementById(id);
  if(tab){ 
    tab.style.display="block";
    if(id==="tabVnes"){ 
      setTimeout(async ()=>{
        await loadKategorii();
        await loadArtikliDropdown();
      }, 10); 
    }
  }
}
window.showTab=showTab;

function logout(){ localStorage.removeItem("magacin_pass"); location.reload(); }
window.logout=logout;

// üîπ –í—á–∏—Ç—É–≤–∞—ö–µ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ–¥ Firebase
async function loadKategorii(){
  const snap = await getDocs(collection(db,"artikli"));
  const kategorii = new Set();
  snap.docs.forEach(doc=>kategorii.add(doc.data().kategorija));
  const select = document.getElementById("kategorijaSelect");
  select.innerHTML = `<option value="">–°–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>`;
  kategorii.forEach(k=>{
    const opt = document.createElement("option");
    opt.value = k;
    opt.text = k;
    select.appendChild(opt);
  });
}

// üîπ –í—á–∏—Ç—É–≤–∞—ö–µ –Ω–∞ –∞—Ä—Ç–∏–∫–ª–∏ –æ–¥ Firebase
let artikliLista = [];
async function loadArtikliDropdown(){
  const select = document.getElementById("artiklSelect");
  if(!select) return;

  const snap = await getDocs(collection(db,"artikli"));
  artikliLista = snap.docs.map(doc=>doc.data());

  const kategorija = document.getElementById("kategorijaSelect").value;
  select.innerHTML = "";
  artikliLista.forEach(a=>{
    if(!kategorija || a.kategorija === kategorija){
      const option = document.createElement("option");
      option.value = a.ime;
      option.text = `${a.ime} (${a.merka})`;
      option.dataset.merka = a.merka;
      option.dataset.cena = a.cena;
      option.dataset.min = a.minKolicina;
      select.appendChild(option);
    }
  });
}
window.loadArtikliDropdown=loadArtikliDropdown;

// üîπ –í–Ω–µ—Å –Ω–∞ –∞—Ä—Ç–∏–∫–ª–∏
async function dodadiMagacin(e){
  e.preventDefault();
  const select = document.getElementById("artiklSelect");
  if(!select.value) return alert("–û–¥–±–µ—Ä–∏ –∞—Ä—Ç–∏–∫–ª!");
  const ime = select.value;
  const merka = select.options[select.selectedIndex].dataset.merka;
  const cena = parseFloat(select.options[select.selectedIndex].dataset.cena);
  const minKolicina = parseFloat(select.options[select.selectedIndex].dataset.min);
  const kolicina = parseFloat(document.getElementById("vnesKolicina").value);
  if(!kolicina || kolicina <=0) return alert("–í–Ω–µ—Å–∏ –∫–æ–ª–∏—á–∏–Ω–∞!");
  const datum = Timestamp.fromDate(new Date()); // ‚úÖ Timestamp –∑–∞ Firestore
  await addDoc(collection(db,"magacin"),{ime,merka,cena,kolicina,datum,minKolicina});
  document.getElementById("vnesKolicina").value="";
  prikaziArtikli("vnesLista","magacin",true);
}
window.dodadiMagacin=dodadiMagacin;

// üîπ –ü—Ä–∏–∫–∞–∂–∏ –∞—Ä—Ç–∏–∫–ª–∏
async function prikaziArtikli(divID,kolekcija,onlyLast=false){
  const div = document.getElementById(divID);
  div.innerHTML="";
  const snap = await getDocs(collection(db,kolekcija));
  snap.forEach(docu=>{
    const data = docu.data();
    const klas = (data.kolicina < data.minKolicina) ? "red" : "";
    if(onlyLast){
      div.innerHTML=`<div class="${klas}"><b>${data.ime}</b> ‚Äì ${data.kolicina} ${data.merka} ‚ö†Ô∏è</div>`;
    } else {
      div.innerHTML+=`<div class="${klas}"><b>${data.ime}</b> ‚Äì ${data.kolicina} ${data.merka} ‚ö†Ô∏è</div>`;
    }
  });
}

// üîπ –ö–æ–Ω—Ç—Ä–æ–ª–∞ –ø–æ –¥–∞—Ç—É–º
async function kontrolaVnes(startStr,endStr){
  const div = document.getElementById("kontrolaLista");
  div.innerHTML="";
  const snap = await getDocs(collection(db,"magacin"));
  const startDate = new Date(startStr);
  const endDate = new Date(endStr); endDate.setHours(23,59,59);
  snap.forEach(docu=>{
    const data = docu.data();
    const datum = data.datum.toDate ? data.datum.toDate() : new Date(data.datum);
    if(datum>=startDate && datum<=endDate){
      const klas = (data.kolicina < data.minKolicina) ? "red" : "";
      div.innerHTML+=`<div class="${klas}"><b>${data.ime}</b> ‚Äì ${data.kolicina} ${data.merka} ‚ö†Ô∏è ${datum.toLocaleString()}</div>`;
    }
  });
}
window.kontrolaVnes=kontrolaVnes;

</script>
</head>
<body>

<!-- Login -->
<div id="login-card">
<h2>üîí –í–Ω–µ—Å–∏ –ª–æ–∑–∏–Ω–∫–∞</h2>
<input type="password" id="pass" placeholder="–õ–æ–∑–∏–Ω–∫–∞">
<button onclick="checkLogin()">–í–ª–µ–∑–∏</button>
</div>

<!-- Dashboard -->
<div id="dashboard">
<h2>üìã –ì–ª–∞–≤–Ω–æ –º–µ–Ω–∏</h2>
<div class="menu">
<button onclick="showTab('tabVnes')">–í–Ω–µ—Å –Ω–∞ –∞—Ä—Ç–∏–∫–ª–∏</button>
<button onclick="showTab('tabIzlez')">–ò–∑–ª–µ–∑ –Ω–∞ –∞—Ä—Ç–∏–∫–ª–∏</button>
<button onclick="showTab('tabIzvestaj')">–ò–∑–≤–µ—à—Ç–∞—ò (–º–æ–º–µ–Ω—Ç–∞–ª–Ω–∞ —Å–æ—Å—Ç–æ—ò–±–∞)</button>
<button onclick="showTab('tabOcekuvano')">–û—á–µ–∫—É–≤–∞–Ω–æ / –ù–∞—Ä–∞—á–∞–Ω–æ</button>
<button onclick="showTab('tabKontrola')">–ö–æ–Ω—Ç—Ä–æ–ª–∞ –Ω–∞ –≤–Ω–µ—Å</button>
<button class="back-btn" onclick="logout()">Logout</button>
</div>
</div>

<!-- TAB: –í–Ω–µ—Å –Ω–∞ –∞—Ä—Ç–∏–∫–ª–∏ -->
<div class="tab" id="tabVnes">
<h2>‚ûï –í–Ω–µ—Å –Ω–∞ –∞—Ä—Ç–∏–∫–ª–∏</h2>
<select id="kategorijaSelect" onchange="loadArtikliDropdown()">
  <option value="">–°–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
</select>
<select id="artiklSelect"></select>
<input type="number" id="vnesKolicina" placeholder="–ö–æ–ª–∏—á–∏–Ω–∞">
<button onclick="dodadiMagacin(event)">–î–æ–¥–∞–¥–∏</button>
<div id="vnesLista"></div>
</div>

<!-- TAB: –ò–∑–ª–µ–∑ –Ω–∞ –∞—Ä—Ç–∏–∫–ª–∏ -->
<div class="tab" id="tabIzlez">
<h2>‚ûñ –ò–∑–ª–µ–∑ –Ω–∞ –∞—Ä—Ç–∏–∫–ª–∏</h2>
<div id="izlezLista"></div>
</div>

<!-- TAB: –ò–∑–≤–µ—à—Ç–∞—ò -->
<div class="tab" id="tabIzvestaj">
<h2>üìä –ò–∑–≤–µ—à—Ç–∞—ò (–º–æ–º–µ–Ω—Ç–∞–ª–Ω–∞ —Å–æ—Å—Ç–æ—ò–±–∞)</h2>
<div id="lista"></div>
</div>

<!-- TAB: –û—á–µ–∫—É–≤–∞–Ω–æ / –ù–∞—Ä–∞—á–∞–Ω–æ -->
<div class="tab" id="tabOcekuvano">
<h2>üì¶ –û—á–µ–∫—É–≤–∞–Ω–æ / –ù–∞—Ä–∞—á–∞–Ω–æ</h2>
<div id="oczekDiv"></div>
</div>

<!-- TAB: –ö–æ–Ω—Ç—Ä–æ–ª–∞ -->
<div class="tab" id="tabKontrola">
<h2>üîç –ö–æ–Ω—Ç—Ä–æ–ª–∞ –Ω–∞ –≤–Ω–µ—Å</h2>
<input type="date" id="kontrolaStart">
<input type="date" id="kontrolaEnd">
<button onclick="kontrolaVnes(document.getElementById('kontrolaStart').value, document.getElementById('kontrolaEnd').value)">–§–∏–ª—Ç—Ä–∏—Ä–∞—ò</button>
<div id="kontrolaLista"></div>
</div>

</body>
</html>
