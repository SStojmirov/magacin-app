<!DOCTYPE html>
<html lang="mk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Магацин Апликација</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
  body { background-color: #1f2937; color: #f3f4f6; font-family: Arial, sans-serif; margin:0; padding:0; }
    .container { max-width: 800px; margin: 20px auto; padding: 20px; }
    .hidden { display: none; }
    button { background-color: #374151; color: #f3f4f6; border: none; padding: 10px 15px; margin: 5px; border-radius:5px; cursor: pointer; }
    button:hover { background-color: #4b5563; }
    select, input { padding: 5px; border-radius: 5px; border: none; background-color: #374151; color: #f3f4f6; }
   #izvestajContainer {
  margin-top: 20px;
}

.card {
  padding: 8px;
  margin: 4px 0;
  border-radius: 4px;
  font-weight: bold;
}

.card.green { background-color: #2cb130; }  /* над минимум */
.card.red { background-color: #d53e4e; }    /* под минимум */

/* ===== Мобилен респонзив ===== */
@media (max-width: 600px) {
  /* Контейнер и padding */
  .container {
    padding: 10px;
    margin: 10px;
  }

  #loginDiv {
    idth: 100%;
    margin: 5px 0;
    padding: 12px;
    font-size: 1rem;
  }
  
  /* Таб копчиња full-width */
  #menuDiv button {
    width: 100%;
    margin: 5px 0;
    padding: 12px;
    font-size: 1rem;
  }

  /* Input и select full-width */
  select, input {
    width: 100%;
    padding: 10px;
    font-size: 1rem;
    margin-bottom: 10px;
  }

  /* Cards вертикални, полесни за читање */
  .card {
    flex-direction: column;
    align-items: flex-start;
    padding: 10px 12px;
    font-size: 0.95rem;
  }

  /* Извештај scrollable */
  #izvestajList {
    max-height: 60vh;
    overflow-y: auto;
    padding-right: 4px;
  }
}

  </style>
</head>
<body>
<div class="container">
  <h1>Магацин Апликација</h1>

  <div id="loginDiv">
    <h2>Лозинка за пристап</h2>
    <input type="password" id="passInput" placeholder="Лозинка">
    <button onclick="login()">Влези</button>
  </div>

  <div id="appDiv" class="hidden">
    <div id="menuDiv">
      <button onclick="showTab('vnes')">Внес</button>
      <button onclick="showTab('izlez')">Излез</button>
      <button onclick="showTab('izvestaj')">Извештај</button>
      <button onclick="showTab('ocekivano')">Очекувано</button>
      <button onclick="logout()">ЛогАут</button>
    </div>

    <div id="vnesDiv" class="hidden card">
      <h3>Внес на артикл</h3>
      <label>Категорија:</label>
      <select id="catSelect"></select><br><br>
      <label>Артикл:</label>
      <select id="artiklSelect"></select><br><br>
      <label>Количина:</label>
      <input type="number" inputmode="numeric" id="vnesKolicina"><br><br>
      <button onclick="dodadiVnes()">Додади</button>
      <div id="lastVnes"></div>
    </div>

    <div id="izlezDiv" class="hidden card">
      <label>Категорија:</label>
<select id="izlezCatSelect"></select><br><br>
<label>Артикл:</label>
<select id="izlezSelect"></select><br><br>
<label>Количина:</label>
<input type="number" inputmode="numeric" id="izlezKolicina"><br><br>
<button onclick="dodadiIzlez()">Додади Излез</button>

    </div>

    <div id="izvestajDiv" class="hidden card">
      <h3>Моментална состојба</h3>
      <div id="izvestajContainer">
  <label>Филтер по категорија:</label>
  <select id="izvestajCatSelect">
    <option value="">Сите категории</option>
  </select>
  <div id="izvestajList"></div>
</div>


    </div>

    <div id="ocekivanoDiv" class="hidden card">
  <h3>Очекувано (нарачано)</h3>

  <label>Категорија:</label>
  <select id="ocekCatSelect" onchange="loadOcekArtikli()"></select><br>

  <label>Артикл:</label>
  <select id="ocekSelect"></select><br>

  <label>Количина:</label>
  <input type="number" id="ocekKolicina" inputmode="numeric" pattern="[0-9]*"><br>

  <button onclick="dodadiOcek()">Додади Очекувано</button>

  <div id="ocekList"></div>
</div>
</div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAbCqqSwKQ62Q38K-DM15jsZQePloDD8XM",
  authDomain: "magacinapp-6a8f5.firebaseapp.com",
  projectId: "magacinapp-6a8f5",
  storageBucket: "magacinapp-6a8f5.firebasestorage.app",
  messagingSenderId: "160054879907",
  appId: "1:160054879907:web:ded639dcd0a9e0a64e4116"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const PASSWORD = "1234";

function login(){
  const p = document.getElementById('passInput').value;
  if(p===PASSWORD){
    document.getElementById('loginDiv').classList.add('hidden');
    document.getElementById('appDiv').classList.remove('hidden');
    loadArtikli();
    loadIzlez();
    loadOcek();
    loadIzvestaj();
  } else { alert('Неточна лозинка'); }
}
function logout(){ location.reload(); }

function showTab(tab){
  ['vnesDiv','izlezDiv','izvestajDiv','ocekivanoDiv'].forEach(d=>{
    document.getElementById(d).classList.add('hidden');
  });
  document.getElementById(tab+'Div').classList.remove('hidden');
}

let artikliData = [];

async function loadArtikli(){
  const snap = await db.collection('artikli').get();
  artikliData = snap.docs.map(d=>({id:d.id, ...d.data()}));
  const catSelect = document.getElementById('catSelect');
  const artiklSelect = document.getElementById('artiklSelect');
  catSelect.innerHTML='<option value="">Сите категории</option>';
  artiklSelect.innerHTML='';
  const cats = [...new Set(artikliData.map(a=>a.kategorija))];
  cats.forEach(c=>{ catSelect.innerHTML+=`<option value='${c}'>${c}</option>`; });
  artikliData.forEach(a=>{ artiklSelect.innerHTML+=`<option value='${a.id}'>${a.ime} (${a.merka})</option>` });
}

function filterArtikli(){
  const cat = document.getElementById('catSelect').value;
  const sel = document.getElementById('artiklSelect');
  sel.innerHTML='';
  artikliData.filter(a=>!cat||a.kategorija===cat).forEach(a=>{ sel.innerHTML+=`<option value='${a.id}'>${a.ime} (${a.merka})</option>`; });
}
document.getElementById('catSelect').addEventListener('change', filterArtikli);

async function dodadiVnes(){
  const aId = document.getElementById('artiklSelect').value;
  const k = Number(document.getElementById('vnesKolicina').value);
  if(!aId||!k){ alert('Пополни полиња'); return; }
  const a = artikliData.find(x=>x.id===aId);
  await db.collection('promet').add({
    artiklId:a.id, ime:a.ime, merka:a.merka, kategorija:a.kategorija, kolicina:k, tip:'vnes', datum:new Date()
  });
  document.getElementById('vnesKolicina').value='';
  document.getElementById('lastVnes').innerText=`Последен внес: ${a.ime} - ${k} ${a.merka}`;
  loadIzvestaj();
}

// Вчитување на артикли во табот „Излез“
async function loadIzlez(){
  const catSelect = document.getElementById('izlezCatSelect');
  const sel = document.getElementById('izlezSelect');
  sel.innerHTML='';
  catSelect.innerHTML='<option value="">Сите категории</option>';

  // Пресметка на моментална количина
  const snap = await db.collection('promet').get();
  const records = snap.docs.map(d=>d.data());
  const map = new Map();
  records.forEach(r=>{
    const key = r.artiklId;
    const cur = map.get(key) || { kolicina:0 };
    cur.kolicina += (r.tip==='vnes' ? r.kolicina : -r.kolicina);
    map.set(key, cur);
  });

  // Додавање на категории
  const cats = [...new Set(artikliData.map(a=>a.kategorija))];
  cats.forEach(c => { catSelect.innerHTML += `<option value="${c}">${c}</option>`; });

  // Додавање на артикли со количина > 0
  artikliData.forEach(a=>{
    const kolicina = map.get(a.id)?.kolicina || 0;
    if(kolicina > 0){
      sel.innerHTML += `<option value="${a.id}">${a.ime} (${kolicina} ${a.merka})</option>`;
    }
  });
}

// Филтрирање по категорија
document.getElementById('izlezCatSelect').addEventListener('change', async ()=>{
  const cat = document.getElementById('izlezCatSelect').value;
  const sel = document.getElementById('izlezSelect');
  sel.innerHTML='';

  // Пресметка на количина
  const snap = await db.collection('promet').get();
  const records = snap.docs.map(d=>d.data());
  const map = new Map();
  records.forEach(r=>{
    const key = r.artiklId;
    const cur = map.get(key) || { kolicina:0 };
    cur.kolicina += (r.tip==='vnes' ? r.kolicina : -r.kolicina);
    map.set(key, cur);
  });

  artikliData.forEach(a=>{
    const kolicina = map.get(a.id)?.kolicina || 0;
    if(kolicina > 0 && (!cat || a.kategorija===cat)){
      sel.innerHTML += `<option value="${a.id}">${a.ime} (${kolicina} ${a.merka})</option>`;
    }
  });
});

// Внес на излез со проверка за достапна количина
async function dodadiIzlez(){
  const aId = document.getElementById('izlezSelect').value;
  const k = Number(document.getElementById('izlezKolicina').value);
  if(!aId||!k){ alert('Пополни полиња'); return; }

  // Пресметка на моментална количина
  const snap = await db.collection('promet').get();
  const records = snap.docs.map(d=>d.data());
  const map = new Map();
  records.forEach(r=>{
    const key = r.artiklId;
    const cur = map.get(key) || { kolicina:0 };
    cur.kolicina += (r.tip==='vnes' ? r.kolicina : -r.kolicina);
    map.set(key, cur);
  });

  const dostupno = map.get(aId)?.kolicina || 0;
  if(k > dostupno){
    alert(`Немаш доволно количина! Достапно: ${dostupno}`);
    return;
  }

  const a = artikliData.find(x=>x.id===aId);
  await db.collection('promet').add({
    artiklId:a.id, ime:a.ime, merka:a.merka, kategorija:a.kategorija, kolicina:k, tip:'izlez', datum:new Date()
  });

  document.getElementById('izlezKolicina').value='';
  loadIzvestaj();
  loadIzlez(); // обнови dropdown
}




// Вчитување на артикли од Firebase
async function loadArtikliFirebase() {
  const snap = await db.collection('artikli').get();
  artikliData = snap.docs.map(d => d.data());
  initIzvestaj(); // стартување на извештајот после што е наполнета
}

// Пополнување на dropdown со категории
function loadIzvestajCategories(){
  const catSelect = document.getElementById('izvestajCatSelect');
  catSelect.innerHTML = '<option value="">Сите категории</option>'; // најгоре
  const cats = [...new Set(artikliData.map(a=>a.kategorija))];
  cats.forEach(c => { 
    catSelect.innerHTML += `<option value="${c}">${c}</option>`; 
  });
}

// Прикажување на извештај
async function loadIzvestaj(){
  const selectedCat = document.getElementById('izvestajCatSelect').value;
  const snap = await db.collection('promet').get();
  const records = snap.docs.map(d=>d.data());

  const map = new Map();
  records.forEach(r=>{
    const key = r.artiklId;
    const cur = map.get(key) || { 
      ime: r.ime, 
      merka: r.merka, 
      kategorija: r.kategorija, 
      kolicina: 0, 
      minKolicina: (artikliData.find(a=>a.id===key)||{}).minKolicina || 0 
    };
    cur.kolicina += (r.tip==='vnes' ? r.kolicina : -r.kolicina);
    map.set(key, cur);
  });

  let list = Array.from(map.values());
  if(selectedCat) list = list.filter(a => a.kategorija === selectedCat);

  // Артикли под минимум на почеток
  list.sort((a,b)=>{
    const aLow = a.kolicina <= a.minKolicina ? 0 : 1;
    const bLow = b.kolicina <= b.minKolicina ? 0 : 1;
    return aLow - bLow;
  });

  const div = document.getElementById('izvestajList');
  div.innerHTML='';
  list.forEach(a=>{
    const cls = a.kolicina <= a.minKolicina ? 'red' : 'green';
    div.innerHTML += `<div class='card ${cls}'>${a.ime} (${a.merka}) - ${a.kolicina}</div>`;
  });
}

// Event listener за категорија
document.getElementById('izvestajCatSelect').addEventListener('change', ()=>{
  loadIzvestaj();
});

// Иницијализација
function initIzvestaj(){
  loadIzvestajCategories();
  loadIzvestaj();
}

// Стартување
loadArtikliFirebase();

  function loadOcekCategories() {
  const ocekCatSelect = document.getElementById('ocekCatSelect');
  ocekCatSelect.innerHTML = '<option value="">Избери категорија</option>';

  firebase.firestore().collection('artikli')
    .get()
    .then(snapshot => {
      const categories = new Set();
      snapshot.forEach(doc => categories.add(doc.data().kategorija));

      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        ocekCatSelect.appendChild(option);
      });
    });
}

// Повикај го при load на апликацијата
loadOcekCategories();

  function loadOcekArtikli() {
  const ocekSelect = document.getElementById('ocekSelect');
  const selectedCat = document.getElementById('ocekCatSelect').value;

  ocekSelect.innerHTML = '';

  if(!selectedCat) return;

  firebase.firestore().collection('artikli')
    .where('kategorija', '==', selectedCat)
    .get()
    .then(snapshot => {
      snapshot.forEach(doc => {
        const option = document.createElement('option');
        option.value = doc.data().naziv; // име на артикл
        option.textContent = doc.data().naziv;
        ocekSelect.appendChild(option);
      });
    });
}


function loadOcek() {
  const ocekList = document.getElementById('ocekList');
  ocekList.innerHTML = '';

  firebase.firestore().collection('ocekuvano')
    .orderBy('timestamp', 'desc')
    .get()
    .then(snapshot => {
      snapshot.forEach(doc => {
        const data = doc.data();
        const div = document.createElement('div');
        div.classList.add('card');

        // Прикажи артикл + количина + корисник
        div.textContent = `${data.artikl} - ${data.kolicina} (нарачано од ${data.user})`;

        // Копче за бришење
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Избриши';
        delBtn.style.marginLeft = '10px';
        delBtn.onclick = () => {
          if(confirm('Дали си сигурен дека сакаш да го избришеш?')) {
            firebase.firestore().collection('ocekuvano').doc(doc.id).delete()
              .then(() => loadOcek());
          }
        };

        div.appendChild(delBtn);
        ocekList.appendChild(div);
      });
    });
}


function dodadiOcek() {
  const artikl = document.getElementById('ocekSelect').value;
  const kolicina = Number(document.getElementById('ocekKolicina').value);

  if(!artikl || !kolicina) {
    alert('Внеси артикл и количина!');
    return;
  }

  firebase.firestore().collection('ocekuvano').add({
    artikl: artikl,
    kolicina: kolicina,
    user: currentUser,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  })
  .then(() => {
    document.getElementById('ocekKolicina').value = '';
    loadOcek(); // обнови список
  });
}

  function showTab(tab) {
  const tabs = ['vnesDiv','izlezDiv','izvestajDiv','ocekivanoDiv'];
  tabs.forEach(t => document.getElementById(t).classList.add('hidden'));
  
  // Прикажи само избраниот
  document.getElementById(tab + 'Div').classList.remove('hidden');
}

// На мобилен при стартување покажи првиот таб (Внес)
if(window.innerWidth <= 600){
  showTab('vnes');
}

</script>
</body>
